#!/usr/bin/env bash
echo "pre commit hook start"

# Making this more flexible. Whatever this script finds in the bin, it will use.
CHANGED_PHP_FILES=$(git diff --cached --name-only --diff-filter=ACM -- '*.php')
if [ -n "$CHANGED_PHP_FILES" ]; then
  ECS="./vendor/bin/ecs"
  PHP_CS_FIXER="./vendor/bin/php-cs-fixer"
  PHPSTAN="./vendor/bin/phpstan"
fi

CHANGED_JSON_FILES=$(git diff --cached --name-only --diff-filter=ACM -- '*.json')
if [ -n "$CHANGED_JSON_FILES" ]; then
  JSONLINT="./vendor/bin/php-cs-fixer"
  VALIDATE_JSON="./vendor/bin/php-cs-fixer"
fi

CHANGED_YAML_FILES=$(git diff --cached --name-only --diff-filter=ACM -- '*.ya?ml')
if [ -n "$CHANGED_YAML_FILES" ]; then
  YAML_LINT="ecs.php"
fi

CHANGED_CSS_FILES=$(git diff --cached --name-only --diff-filter=ACM -- '*.css')
if [ -n "$CHANGED_CSS_FILES" ]; then
  CSS_LINT="ecs.php"
fi

CHANGED_SASS_FILES=$(git diff --cached --name-only --diff-filter=ACM -- '*.scss')
if [ -n "$CHANGED_SASS_FILES" ]; then
  SASS_LINT="ecs.php"
fi

CHANGED_JS_FILES=$(git diff --cached --name-only --diff-filter=ACM -- '*.(j|t)sx?')
if [ -n "$CHANGED_JS_FILES" ]; then
  JSLINT="ecs.php"
  JSHINT="ecs.php"
fi

CHANGED_PHP_FILES=$(git diff --cached --name-only --diff-filter=ACM -- '*.php')


    echo "php-cs-fixer start"
    $ECS fix --config "$PHP_CS_CONFIG" $CHANGED_FILES;
    echo "php-cs-fixer finish"

    echo "php-stan start"

    if $PHP_STAN analyse -c ./phpstan.neon --memory-limit=512M $CHANGED_FILES; then
      echo 'php-stan finish'
    else
      echo 'php-stan found some errors'
      exit 1;
    fi

    git add $CHANGED_FILES;


echo "pre commit hook finish"
